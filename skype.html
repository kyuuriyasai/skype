<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skype Web Clone (Delete Chat)</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --skype-blue: #0078D4;
            --bg-app: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --bg-chat-header: #FFFFFF;
            --bg-chat-body: #F2F2F2;
            --bg-input: #FFFFFF;
            --border-color: #E5E5E5;
            --text-primary: #242424;
            --text-secondary: #605E5C;
            --hover-bg: #F5F5F5;
            --bubble-me: #EBF4FF;
            --bubble-other: #FFFFFF;
            --status-online: #92C353;
            --status-offline: #B0B0B0;
            --menu-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        body.dark-theme {
            --bg-app: #201F1E;
            --bg-sidebar: #292827;
            --bg-chat-header: #292827;
            --bg-chat-body: #1B1A19;
            --bg-input: #292827;
            --border-color: #484644;
            --text-primary: #FFFFFF;
            --text-secondary: #A19F9D;
            --hover-bg: #323130;
            --bubble-me: #004578;
            --bubble-other: #3B3A39;
        }

        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; margin: 0; background: var(--bg-app); height: 100vh; overflow: hidden; display: flex; color: var(--text-primary); }
        button { cursor: pointer; font-family: inherit; border: none; background: transparent; }
        svg { fill: currentColor; }

        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0078D4 0%, #00B4FF 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; width: 400px; padding: 40px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; display: flex; flex-direction: column; gap: 15px; }
        .login-logo { width: 60px; height: 60px; margin: 0 auto 10px; background: var(--skype-blue); color: white; border-radius: 50%; font-size: 36px; font-weight: bold; display: flex; align-items: center; justify-content: center; font-family: "Segoe UI", sans-serif; }
        .login-logo::after { content: "S"; position: relative; top: -1px; }
        .login-input { padding: 12px; border: 1px solid #CCC; border-radius: 4px; font-size: 15px; width: 100%; }
        .login-btn { padding: 12px; background: var(--skype-blue); color: white; border-radius: 4px; font-weight: 600; font-size: 15px; margin-top: 10px; width: 100%; }

        /* „Ç¢„Éó„É™Êú¨‰Ωì */
        #app { display: none; width: 100%; height: 100%; }
        #sidebar { width: 350px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; }
        
        .sidebar-header { padding: 12px 16px; display: flex; flex-direction: column; gap: 12px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .my-profile-pill { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 4px 8px 4px 4px; border-radius: 20px; transition: background 0.2s; }
        .my-profile-pill:hover { background: var(--hover-bg); }
        
        .search-container { position: relative; }
        .search-input { width: 100%; padding: 8px 12px 8px 36px; border-radius: 4px; border: 1px solid transparent; background: var(--hover-bg); color: var(--text-primary); font-size: 14px; }
        .search-icon { position: absolute; left: 10px; top: 9px; width: 16px; height: 16px; fill: var(--text-secondary); }

        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border-color); padding: 0 8px; }
        .tab-btn { flex: 1; padding: 12px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid transparent; text-align: center; }
        .tab-btn.active { color: var(--skype-blue); border-bottom-color: var(--skype-blue); }

        #tab-chats, #tab-contacts { flex: 1; overflow-y: auto; }
        .list-item { display: flex; align-items: center; padding: 10px 16px; cursor: pointer; height: 68px; position: relative; }
        .list-item:hover, .list-item.active { background: var(--hover-bg); }
        .list-item.active::before { content: ""; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background: var(--skype-blue); border-radius: 0 4px 4px 0; }
        
        .avatar-container { position: relative; width: 40px; height: 40px; flex-shrink: 0; margin-right: 12px; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background: var(--skype-blue); color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; }
        .status-dot { position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-sidebar); background-color: var(--status-offline); }
        .status-dot.online { background-color: var(--status-online); }

        .list-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .list-name { font-weight: 600; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .list-sub { font-size: 13px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* „ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ */
        #chat-main { flex: 1; display: none; flex-direction: column; background: var(--bg-chat-body); min-width: 0; position: relative; }
        .chat-header { height: 60px; background: var(--bg-chat-header); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 5; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 4px; min-height: 0; }
        .msg-container { display: flex; gap: 10px; margin-top: 8px; max-width: 70%; }
        .msg-container.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-bubble { padding: 10px 16px; border-radius: 8px; font-size: 15px; word-break: break-word; line-height: 1.5; color: var(--text-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; }
        .msg-container.other .msg-bubble { background: var(--bubble-other); border-top-left-radius: 0; }
        .msg-container.me .msg-bubble { background: var(--bubble-me); border-top-right-radius: 0; }
        .msg-time { font-size: 10px; opacity: 0.6; margin-top: 4px; text-align: right; display: block; }
        .msg-image { max-width: 100%; border-radius: 8px; cursor: pointer; display: block; margin-bottom: 4px; }

        .input-area { padding: 16px; background: var(--bg-input); border-top: 1px solid var(--border-color); display: flex; align-items: flex-end; gap: 10px; }
        .input-wrapper { flex: 1; background: var(--hover-bg); border-radius: 20px; border: 1px solid transparent; min-height: 40px; display: flex; align-items: center; padding: 4px 16px; }
        .msg-input { flex: 1; border: none; background: transparent; font-size: 15px; color: var(--text-primary); resize: none; max-height: 100px; padding: 8px 0; font-family: inherit; }
        
        .action-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; color: var(--skype-blue); border-radius: 4px; cursor: pointer; }
        .action-btn:hover { background: var(--hover-bg); }
        .action-btn.danger:hover { background: #fdf0f0; color: #d13438; }

        /* „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº */
        .context-menu { position: fixed; background: var(--bg-app); border-radius: 6px; box-shadow: var(--menu-shadow); display: none; z-index: 99999; width: 200px; padding: 5px 0; border: 1px solid var(--border-color); }
        .context-item { padding: 10px 15px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
        .context-item:hover { background: var(--hover-bg); }
        .context-item.delete { color: #d13438; }
        .context-item.delete:hover { background: #fdf0f0; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--bg-app); width: 400px; max-width: 90%; border-radius: 8px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); color: var(--text-primary); }
        
        .search-result-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .add-friend-btn { background: var(--skype-blue); color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; }
        .add-friend-btn:disabled { background: #ccc; cursor: default; }

        /* ÈÄöË©±ÁîªÈù¢ */
        #call-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #202020; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .call-avatar { width: 100px; height: 100px; background: #E5E5E5; border-radius: 50%; color: #333; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2); } 70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        @media (max-width: 768px) { #sidebar { width: 100%; } #chat-placeholder, #chat-main { display: none; } #app.in-chat #sidebar { display: none; } #app.in-chat #chat-main { display: flex; } }
    </style>
</head>
<body onclick="app.ui.hideContextMenu()">
    <div id="login-overlay">
        <div class="login-card">
            <div class="login-logo"></div>
            <h2 style="margin:0; font-weight:600;">Skype„Å∏„Çà„ÅÜ„Åì„Åù</h2>
            <div id="auth-error" style="color:red; font-size:13px; display:none;"></div>
            <input type="text" id="login-id" class="login-input" placeholder="ID„ÇíÂÖ•Âäõ" autocomplete="username">
            <input type="password" id="login-pass" class="login-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" autocomplete="current-password">
            <button class="login-btn" onclick="app.auth.submit()" id="auth-btn">„Çµ„Ç§„É≥„Ç§„É≥</button>
            <div style="font-size:13px; margin-top:10px;">
                <a href="#" onclick="app.auth.toggleMode(); return false;" id="auth-toggle-link">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</a>
            </div>
        </div>
    </div>

    <div id="app">
        <div id="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <div class="my-profile-pill" onclick="app.settings.open()">
                        <div class="avatar-container" style="width:32px; height:32px; margin:0;">
                            <div class="avatar" id="my-avatar" style="font-size:14px;">?</div>
                            <div class="status-dot online" style="border-width:2px; right:-2px; bottom:-2px;"></div>
                        </div>
                        <div style="flex:1;">
                            <div id="my-name-display" style="font-weight:700; font-size:14px;">...</div>
                        </div>
                    </div>
                </div>
                <div class="search-container">
                    <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" class="search-input" placeholder="Ê§úÁ¥¢" onfocus="app.search.open()">
                </div>
            </div>

            <div class="sidebar-tabs">
                <div class="tab-btn active" id="tab-btn-chats" onclick="app.ui.switchTab('chats')">„ÉÅ„É£„ÉÉ„Éà</div>
                <div class="tab-btn" id="tab-btn-contacts" onclick="app.ui.switchTab('contacts')">ÈÄ£Áµ°ÂÖà</div>
            </div>

            <div id="tab-chats">
                <div class="list-item" onclick="app.addRoomPrompt()" style="color:var(--skype-blue);">
                    <div class="avatar" style="width:32px; height:32px; background:var(--hover-bg); color:var(--skype-blue); margin-right:12px;">+</div>
                    <span style="font-weight:600; font-size:14px;">Êñ∞„Åó„ÅÑ„ÉÅ„É£„ÉÉ„Éà</span>
                </div>
                <div id="chat-list-container"></div>
            </div>

            <div id="tab-contacts" style="display:none;">
                <div class="list-item" onclick="app.search.open()" style="color:var(--skype-blue);">
                    <div class="avatar" style="width:32px; height:32px; background:var(--hover-bg); color:var(--skype-blue); margin-right:12px;">+</div>
                    <span style="font-weight:600; font-size:14px;">Êñ∞„Åó„ÅÑÈÄ£Áµ°ÂÖà</span>
                </div>
                <div id="contact-list-container"></div>
            </div>
        </div>

        <div id="chat-placeholder" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#888;">
            <div style="font-size:60px;">üëã</div>
            <h3>Skype„Å∏„Çà„ÅÜ„Åì„Åù</h3>
        </div>

        <div id="chat-main">
            <div class="chat-header">
                <div style="display:flex; align-items:center;">
                    <button onclick="app.ui.closeRoom()" style="margin-right:10px; display:none;" id="mobile-back-btn">‚Üê</button>
                    <div class="avatar-container" style="width:36px; height:36px;">
                        <div class="avatar" id="header-avatar">?</div>
                        <div class="status-dot" id="header-status-dot"></div>
                    </div>
                    <div style="margin-left:10px;">
                        <div class="list-name" id="header-room-title">Room</div>
                        <div class="list-sub" id="header-room-status"></div>
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" onclick="app.startVoiceCall(true)" title="„Éì„Éá„Ç™ÈÄöË©±"><svg viewBox="0 0 24 24" width="24" height="24" fill="var(--skype-blue)"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
                    <button class="action-btn" onclick="app.startVoiceCall(false)" title="Èü≥Â£∞ÈÄöË©±"><svg viewBox="0 0 24 24" width="22" height="22" fill="var(--skype-blue)"><path d="M20 15.5c-1.25 0-2.45-.2-3.57-.57-.35-.11-.74-.03-1.02.24l-2.2 2.2c-2.83-1.44-5.15-3.75-6.59-6.59l2.2-2.21c.28-.26.36-.65.25-1C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1 13.81 13.81 0 0 0 14 14c.55 0 1-.45 1-1v-3.5c0-.55-.45-1-1-1z"/></svg></button>
                    <button class="action-btn danger" onclick="app.ui.deleteActiveRoom()" title="‰ºöË©±„ÇíÂâäÈô§"><svg viewBox="0 0 24 24" width="20" height="20"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                </div>
            </div>

            <div id="messages"></div>

            <div class="input-area">
                <div class="action-btn" onclick="document.getElementById('file-input').click()" title="„Éï„Ç°„Ç§„É´„ÇíÈÄÅ‰ø°">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                </div>
                <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="app.handleFileSelect(this)">
                
                <div class="input-wrapper">
                    <input type="text" id="msg-input" class="msg-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" autocomplete="off">
                </div>
                <button class="login-btn" style="width:40px; height:40px; border-radius:50%; margin:0; padding:0; display:flex; align-items:center; justify-content:center;" onclick="app.send()">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
            
            <div id="call-screen">
                <div class="call-avatar" id="call-avatar">?</div>
                <div id="call-status" style="font-size:20px; margin-bottom:30px;">Âëº„Å≥Âá∫„Åó‰∏≠...</div>
                <button onclick="app.endCall()" style="width:60px; height:60px; border-radius:50%; background:#C4314B; color:white; display:flex; align-items:center; justify-content:center;">
                    <svg viewBox="0 0 24 24" width="32" height="32" fill="white"><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.996.996 0 0 1 0-1.41C4.59 7.94 8.07 6 12 6s7.41 1.94 11.71 5.67c.39.39.39 1.02 0 1.41l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"/></svg>
                </button>
                <audio id="remote-audio" autoplay playsinline></audio>
            </div>
        </div>
    </div>

    <div id="context-menu" class="context-menu">
        <div class="context-item delete" onclick="app.ui.deleteTargetRoom()">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            ‰ºöË©±„ÇíÂâäÈô§
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) app.settings.close()">
        <div class="modal-content">
            <h3 style="margin-top:0;">Ë®≠ÂÆö</h3>
            <label style="display:block; margin-bottom:5px; font-size:12px;">Ë°®Á§∫Âêç</label>
            <input type="text" id="set-display-name" class="login-input" style="margin-bottom:15px;">
            <label style="display:block; margin-bottom:5px; font-size:12px;">Áä∂ÊÖã</label>
            <input type="text" id="set-status" class="login-input" style="margin-bottom:15px;">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                <span>„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</span>
                <input type="checkbox" id="set-theme-toggle" onchange="app.settings.toggleTheme()">
            </div>
            <div style="display:flex; justify-content:space-between;">
                <button onclick="app.auth.logout()" style="color:#C4314B;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                <button onclick="app.settings.save()" style="background:var(--skype-blue); color:white; padding:8px 16px; border-radius:4px;">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal-overlay" onclick="if(event.target===this) app.search.close()">
        <div class="modal-content">
            <h3 style="margin-top:0;">„É¶„Éº„Ç∂„Éº„ÇíËøΩÂä†</h3>
            <p style="font-size:12px; color:#666; margin-bottom:10px;">„Ç™„É≥„É©„Ç§„É≥„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÊ§úÁ¥¢„Åß„Åç„Åæ„Åô„ÄÇ</p>
            <input type="text" id="search-query-modal" class="login-input" style="margin-bottom:10px;" placeholder="ID„Åæ„Åü„ÅØÂêçÂâç„ÅßÊ§úÁ¥¢">
            <button onclick="app.search.execute()" style="background:var(--skype-blue); color:white; padding:8px 16px; border-radius:4px; width:100%;">Ê§úÁ¥¢</button>
            <div id="search-results" style="margin-top:15px; border-top:1px solid #eee;"></div>
        </div>
    </div>
    
    <div id="image-modal" class="modal-overlay" onclick="this.style.display='none'">
        <img id="modal-img" style="max-width:90%; max-height:90%; border-radius:4px;">
    </div>

    <script>
        const app = {
            broker: 'wss://test.mosquitto.org:8081',
            client: null, user: null, chats: {}, contacts: [], 
            networkDirectory: {}, 
            activeRoom: null, targetRoom: null, // targetRoom for context menu
            rtc: { pc: null, stream: null, iceQueue: [] },

            auth: {
                mode: 'login',
                getUsersDb: () => JSON.parse(localStorage.getItem('skyped_v19_users') || '{}'),
                toggleMode: function() {
                    this.mode = (this.mode === 'login') ? 'signup' : 'login';
                    document.querySelector('.login-card h2').innerText = this.mode === 'login' ? 'Skype„Å∏„Çà„ÅÜ„Åì„Åù' : '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê';
                    document.getElementById('auth-btn').innerText = this.mode === 'login' ? '„Çµ„Ç§„É≥„Ç§„É≥' : 'Ê¨°„Å∏';
                },
                submit: function() {
                    const id = document.getElementById('login-id').value.trim();
                    const pass = document.getElementById('login-pass').value.trim();
                    const errEl = document.getElementById('auth-error');
                    if(!id || !pass) { errEl.innerText = "ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"; errEl.style.display = 'block'; return; }
                    
                    const db = this.getUsersDb();
                    if (this.mode === 'signup') {
                        if (db[id]) { errEl.innerText = "ID„Åå‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô"; errEl.style.display = 'block'; }
                        else {
                            db[id] = { password: pass, theme: 'light', name: id, status: 'Active' };
                            localStorage.setItem('skyped_v19_users', JSON.stringify(db));
                            this.loginSuccess(id, db[id]);
                        }
                    } else {
                        if (db[id] && db[id].password === pass) { this.loginSuccess(id, db[id]); }
                        else { errEl.innerText = "Ë™çË®ºÂ§±Êïó"; errEl.style.display = 'block'; }
                    }
                },
                loginSuccess: function(id, data) {
                    app.user = { id: id, displayName: data.name, status: data.status, theme: data.theme, tempId: id+Math.random().toString(36) };
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    app.loadUserData();
                    app.settings.applyUI();
                    app.connect();
                },
                logout: () => location.reload()
            },

            loadUserData: function() {
                try {
                    const saved = JSON.parse(localStorage.getItem(`skyped_v19_chats_${this.user.id}`) || '{}');
                    this.chats = saved;
                    Object.keys(this.chats).forEach(k => {
                        const room = this.chats[k];
                        if (!Array.isArray(room.messages)) room.messages = [];
                        room.msgIds = new Set(room.messages.map(m => m.id));
                    });
                } catch(e) { this.chats = {}; }
                this.contacts = JSON.parse(localStorage.getItem(`skyped_v19_contacts_${this.user.id}`) || '[]');
                this.ui.renderChatList();
                this.ui.renderContactList();
            },
            saveData: function() {
                localStorage.setItem(`skyped_v19_chats_${this.user.id}`, JSON.stringify(this.chats));
                localStorage.setItem(`skyped_v19_contacts_${this.user.id}`, JSON.stringify(this.contacts));
            },

            ui: {
                tab: 'chats',
                switchTab: function(t) {
                    this.tab = t;
                    document.getElementById('tab-chats').style.display = t==='chats'?'block':'none';
                    document.getElementById('tab-contacts').style.display = t==='contacts'?'block':'none';
                    document.getElementById('tab-btn-chats').classList.toggle('active', t==='chats');
                    document.getElementById('tab-btn-contacts').classList.toggle('active', t==='contacts');
                },
                renderChatList: function() {
                    const c = document.getElementById('chat-list-container'); c.innerHTML = '';
                    const sorted = Object.keys(app.chats).sort((a,b) => {
                        const ta = app.chats[a].messages.at(-1)?.timestamp || 0;
                        const tb = app.chats[b].messages.at(-1)?.timestamp || 0;
                        return tb - ta;
                    });
                    sorted.forEach(rid => {
                        const room = app.chats[rid];
                        const isActive = rid === app.activeRoom;
                        const div = document.createElement('div');
                        div.className = `list-item ${isActive?'active':''}`;
                        div.onclick = () => app.ui.openRoom(rid);
                        div.oncontextmenu = (e) => app.ui.showContextMenu(e, rid); // Âè≥„ÇØ„É™„ÉÉ„ÇØ
                        
                        let online = false;
                        if(room.type==='direct' && room.partnerId) online = app.isUserOnline(room.partnerId);
                        
                        div.innerHTML = `
                            <div class="avatar-container">
                                <div class="avatar">${(room.name||"?")[0]}</div>
                                ${room.type==='direct' ? `<div class="status-dot ${online?'online':''}"></div>` : ''}
                            </div>
                            <div class="list-info">
                                <div class="list-name">${app.escape(room.name)}</div>
                                <div class="list-sub" style="${room.unread?'font-weight:bold;color:var(--text-primary)':''}">
                                    ${app.escape(room.lastMsg || '')}
                                </div>
                            </div>
                        `;
                        c.appendChild(div);
                    });
                },
                renderContactList: function() {
                    const c = document.getElementById('contact-list-container'); c.innerHTML = '';
                    app.contacts.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.onclick = () => app.startDirectChat(u);
                        const online = app.isUserOnline(u.id);
                        div.innerHTML = `
                            <div class="avatar-container">
                                <div class="avatar">${u.name[0]}</div>
                                <div class="status-dot ${online?'online':''}"></div>
                            </div>
                            <div class="list-info">
                                <div class="list-name">${app.escape(u.name)}</div>
                                <div class="list-sub">${online ? '„Ç™„É≥„É©„Ç§„É≥' : '„Ç™„Éï„É©„Ç§„É≥'}</div>
                            </div>
                        `;
                        c.appendChild(div);
                    });
                },
                openRoom: function(rid) {
                    if(!app.chats[rid]) return;
                    app.activeRoom = rid;
                    const room = app.chats[rid];
                    room.unread = 0;
                    document.getElementById('chat-placeholder').style.display = 'none';
                    document.getElementById('chat-main').style.display = 'flex';
                    
                    document.getElementById('header-room-title').innerText = room.name;
                    document.getElementById('header-avatar').innerText = (room.name||"?")[0];
                    
                    if(room.type==='direct' && room.partnerId) {
                        const online = app.isUserOnline(room.partnerId);
                        document.getElementById('header-room-status').innerText = online ? '„Ç™„É≥„É©„Ç§„É≥' : '„Ç™„Éï„É©„Ç§„É≥';
                        const dot = document.getElementById('header-status-dot');
                        dot.className = `status-dot ${online?'online':''}`;
                        dot.style.display = 'block';
                    } else {
                        document.getElementById('header-status-dot').style.display = 'none';
                        document.getElementById('header-room-status').innerText = '';
                    }

                    app.renderMessages(rid);
                    app.scrollToBottom();
                    this.renderChatList();
                    
                    if(window.innerWidth <= 768) {
                        document.getElementById('app').classList.add('in-chat');
                        document.getElementById('mobile-back-btn').style.display = 'block';
                    }
                },
                closeRoom: function() { 
                    app.activeRoom = null;
                    document.getElementById('app').classList.remove('in-chat'); 
                    document.getElementById('chat-main').style.display = 'none';
                    document.getElementById('chat-placeholder').style.display = 'flex';
                },
                // --- Context Menu & Delete ---
                showContextMenu: function(e, rid) {
                    e.preventDefault();
                    app.targetRoom = rid;
                    const menu = document.getElementById('context-menu');
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';
                    menu.style.display = 'block';
                },
                hideContextMenu: function() {
                    document.getElementById('context-menu').style.display = 'none';
                },
                deleteTargetRoom: function() {
                    if(app.targetRoom) {
                        app.deleteChat(app.targetRoom);
                        app.targetRoom = null;
                    }
                },
                deleteActiveRoom: function() {
                    if(app.activeRoom) {
                        app.deleteChat(app.activeRoom);
                    }
                }
            },

            deleteChat: function(rid) {
                if(confirm("„Åì„ÅÆ„ÉÅ„É£„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü‰ºöË©±„ÅÆÂ±•Ê≠¥„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ")) {
                    delete app.chats[rid];
                    app.saveData();
                    app.ui.renderChatList();
                    if(app.activeRoom === rid) app.ui.closeRoom();
                }
            },

            // --- Logic ---
            connect: function() {
                this.client = mqtt.connect(this.broker);
                this.client.on('connect', () => {
                    Object.keys(this.chats).forEach(r => this.client.subscribe(`skyped/chat/${r}`));
                    
                    // „Éó„É¨„Çº„É≥„Çπ & ÈÄöÁü•Ë≥ºË™≠
                    this.client.subscribe('skyped/presence/+');
                    this.client.subscribe(`skyped/notify/${this.user.id}`); // Ëá™ÂàÜÂÆõ„ÅÆÈÄöÁü•
                    
                    this.heartbeat(); 
                    setInterval(() => this.heartbeat(), 15000); 
                });
                this.client.on('message', (t, m) => {
                    try {
                        const msgStr = m.toString();
                        const data = JSON.parse(msgStr);
                        
                        // ÈÄöÁü•ÔºàÈÄ£Áµ°ÂÖàËøΩÂä†Ôºâ
                        if(t === `skyped/notify/${this.user.id}`) {
                            if(data.type === 'contact_add') {
                                // Áõ∏Êâã„ÇíËá™ÂãïËøΩÂä†ÔºàÈÄ£Áµ°ÂÖà„Å´„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
                                if (!app.contacts.some(c => c.id === data.fromId)) {
                                    app.contacts.push({ id: data.fromId, name: data.fromName });
                                    app.saveData();
                                    app.ui.renderContactList();
                                    alert(`${data.fromName} „Åï„Çì„Å®Áπã„Åå„Çä„Åæ„Åó„ÅüÔºÅ`);
                                }
                            }
                        }
                        // „Éó„É¨„Çº„É≥„Çπ
                        else if(t.startsWith('skyped/presence/')) {
                            const uid = t.split('/')[2];
                            if(uid !== this.user.id) {
                                app.networkDirectory[uid] = { 
                                    id: uid, name: data.name, lastSeen: Date.now() 
                                };
                                app.ui.renderChatList(); app.ui.renderContactList();
                                if(app.activeRoom && app.chats[app.activeRoom]?.partnerId === uid) {
                                    document.getElementById('header-room-status').innerText = '„Ç™„É≥„É©„Ç§„É≥';
                                    document.getElementById('header-status-dot').classList.add('online');
                                }
                            }
                        } 
                        // „ÉÅ„É£„ÉÉ„Éà
                        else if (t.startsWith('skyped/chat/')) {
                            app.handleMsg(t.split('/').pop(), data);
                        }
                    } catch(e) {}
                });
                document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key==='Enter') this.send(); });
            },
            
            heartbeat: function() { 
                if(this.client) {
                    this.client.publish(`skyped/presence/${this.user.id}`, JSON.stringify({ name: this.user.displayName })); 
                }
            },
            
            isUserOnline: function(uid) { 
                const u = this.networkDirectory[uid];
                return u && (Date.now() - u.lastSeen < 30000); 
            },

            handleMsg: function(rid, pl) {
                if(pl.type === 'sig' && rid === this.activeRoom && pl.target === this.user.id) {
                    this.handleWebRTC(pl);
                    return;
                }
                if(pl.type === 'msg') {
                    // Ëá™Âãï„Åß„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†‰ΩúÊàêÔºàÂèó‰ø°ÊôÇÔºâ
                    if(!this.chats[rid]) {
                         const isDirect = rid.startsWith('d_');
                         const name = isDirect ? (pl.sender || 'Unknown') : 'Group Chat';
                         this.chats[rid] = { type: isDirect?'direct':'group', name: name, messages:[], unread:0, msgIds:new Set() };
                         if(isDirect) this.chats[rid].partnerId = pl.senderId;
                         this.client.subscribe(`skyped/chat/${rid}`);
                    }
                    const room = this.chats[rid];
                    if(room.msgIds.has(pl.id)) return;
                    room.messages.push(pl);
                    room.msgIds.add(pl.id);
                    room.lastMsg = pl.img ? 'ÂÜôÁúü' : pl.text;
                    if(rid === this.activeRoom) { app.renderMessages(rid); app.scrollToBottom(); }
                    else { room.unread++; }
                    this.ui.renderChatList();
                    this.saveData();
                }
            },

            send: function(imgData=null) {
                const txt = document.getElementById('msg-input').value.trim();
                if(!this.activeRoom || (!txt && !imgData)) return;
                const msg = {
                    type: 'msg', id: Math.random().toString(36),
                    sender: this.user.displayName, senderId: this.user.id,
                    text: txt, img: imgData, timestamp: Date.now()
                };
                this.client.publish(`skyped/chat/${this.activeRoom}`, JSON.stringify(msg));
                document.getElementById('msg-input').value = '';
            },

            renderMessages: function(rid) {
                const con = document.getElementById('messages'); con.innerHTML = '';
                if(!this.chats[rid]) return;
                this.chats[rid].messages.forEach(m => {
                    const isMe = m.senderId === this.user.id;
                    const div = document.createElement('div');
                    div.className = `msg-container ${isMe?'me':'other'}`;
                    const senderName = m.sender || "Unknown";
                    let content = '';
                    if(m.img) content += `<img src="${m.img}" class="msg-image" onclick="document.getElementById('modal-img').src=this.src;document.getElementById('image-modal').style.display='flex'">`;
                    if(m.text) content += `<div>${this.escape(m.text)}</div>`;
                    div.innerHTML = `
                        ${!isMe ? `<div class="avatar" style="width:28px;height:28px;font-size:12px;align-self:flex-end;margin-bottom:5px;">${app.escape(senderName[0])}</div>` : ''}
                        <div class="msg-bubble">
                            ${!isMe ? `<div style="font-size:11px;opacity:0.6;margin-bottom:2px;">${app.escape(senderName)}</div>` : ''}
                            ${content}
                            <span class="msg-time">${this.formatTime(m.timestamp)}</span>
                        </div>`;
                    con.appendChild(div);
                });
            },

            startDirectChat: function(u) {
                const ids = [this.user.id, u.id].sort();
                const rid = `d_${ids[0]}_${ids[1]}`;
                if(!this.chats[rid]) {
                    this.chats[rid] = { type:'direct', name:u.name, partnerId:u.id, messages:[], unread:0, msgIds:new Set() };
                    this.client.subscribe(`skyped/chat/${rid}`);
                }
                this.ui.switchTab('chats');
                this.ui.openRoom(rid);
            },
            addRoomPrompt: function() {
                const n = prompt("„ÉÅ„É£„ÉÉ„ÉàÂêç„ÇíÂÖ•Âäõ:");
                if(n) {
                    const rid = `g_${Date.now()}`;
                    this.chats[rid] = { type:'group', name:n, messages:[], unread:0, msgIds:new Set() };
                    this.client.subscribe(`skyped/chat/${rid}`);
                    this.ui.openRoom(rid);
                }
            },
            handleFileSelect: function(el) {
                if(el.files[0]) {
                    const r = new FileReader();
                    r.onload = e => this.send(e.target.result);
                    r.readAsDataURL(el.files[0]);
                }
            },
            search: {
                open: () => {
                    document.getElementById('search-query-modal').value = '';
                    document.getElementById('search-results').innerHTML = '';
                    document.getElementById('search-modal').style.display = 'flex';
                },
                close: () => document.getElementById('search-modal').style.display = 'none',
                execute: function() {
                    const q = document.getElementById('search-query-modal').value.toLowerCase();
                    const res = document.getElementById('search-results'); res.innerHTML = '';
                    Object.values(app.networkDirectory).forEach(u => {
                        if(u.id !== app.user.id && (u.name.toLowerCase().includes(q) || u.id.toLowerCase().includes(q))) {
                            const isAdded = app.contacts.some(c => c.id === u.id);
                            const div = document.createElement('div');
                            div.className = 'search-result-row';
                            div.innerHTML = `
                                <div class="avatar" style="width:32px;height:32px;margin-right:10px;">${u.name[0]}</div>
                                <div style="flex:1"><b>${app.escape(u.name)}</b><br><small>${u.id}</small></div>
                                <button class="add-friend-btn" ${isAdded?'disabled':''} 
                                    onclick="app.search.add('${u.id}','${app.escape(u.name)}')">
                                    ${isAdded ? 'ËøΩÂä†Ê∏à' : 'ËøΩÂä†'}
                                </button>`;
                            res.appendChild(div);
                        }
                    });
                    if(res.innerHTML === '') res.innerHTML = '<div style="padding:10px;text-align:center;color:#666;">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
                },
                add: (id,name) => {
                    if(!app.contacts.some(c => c.id === id)) {
                        app.contacts.push({id,name}); app.saveData(); app.ui.renderContactList(); 
                        
                        // ÂèåÊñπÂêëËøΩÂä†„ÅÆÈÄöÁü•
                        app.client.publish(`skyped/notify/${id}`, JSON.stringify({
                            type: 'contact_add', fromId: app.user.id, fromName: app.user.displayName
                        }));
                        
                        alert(`${name} „Åï„Çì„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇÁõ∏Êâã„ÅÆÈÄ£Áµ°ÂÖà„Å´„ÇÇ„ÅÇ„Å™„Åü„ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ`);
                        app.search.close();
                    }
                }
            },
            settings: {
                open: function() {
                    document.getElementById('set-display-name').value = app.user.displayName;
                    document.getElementById('set-status').value = app.user.status;
                    document.getElementById('set-theme-toggle').checked = app.user.theme === 'dark';
                    document.getElementById('settings-modal').style.display = 'flex';
                },
                close: () => document.getElementById('settings-modal').style.display = 'none',
                toggleTheme: () => document.body.classList.toggle('dark-theme'),
                save: function() {
                    app.user.displayName = document.getElementById('set-display-name').value;
                    app.user.status = document.getElementById('set-status').value;
                    app.user.theme = document.getElementById('set-theme-toggle').checked ? 'dark' : 'light';
                    const db = app.auth.getUsersDb(); 
                    if(db[app.user.id]) {
                        db[app.user.id].theme = app.user.theme;
                        db[app.user.id].name = app.user.displayName;
                        db[app.user.id].status = app.user.status;
                        localStorage.setItem('skyped_v19_users', JSON.stringify(db));
                    }
                    app.settings.applyUI(); app.settings.close();
                    app.heartbeat();
                },
                applyUI: function() {
                    document.getElementById('my-name-display').innerText = app.user.displayName;
                    document.getElementById('my-avatar').innerText = (app.user.displayName||"?")[0];
                    if(app.user.theme === 'dark') document.body.classList.add('dark-theme'); else document.body.classList.remove('dark-theme');
                }
            },
            
            startVoiceCall: async function(video=false) {
                if(!this.activeRoom) return;
                const room = this.chats[this.activeRoom];
                if(room.type !== 'direct') { alert("„Ç∞„É´„Éº„ÉóÈÄöË©±„ÅØÊú™ÂÆüË£Ö„Åß„Åô"); return; }
                this.showCallScreen("Áô∫‰ø°‰∏≠...", room.name[0]);
                try {
                    this.rtc.stream = await navigator.mediaDevices.getUserMedia({audio:true, video:video});
                    this.rtc.pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
                    this.rtc.pc.onicecandidate = e => { if(e.candidate) this.sig('candidate', e.candidate); };
                    this.rtc.pc.ontrack = e => { document.getElementById('remote-audio').srcObject = e.streams[0]; };
                    this.rtc.stream.getTracks().forEach(t=>this.rtc.pc.addTrack(t,this.rtc.stream));
                    const off = await this.rtc.pc.createOffer();
                    await this.rtc.pc.setLocalDescription(off);
                    this.sig('offer', off);
                } catch(e) { alert("„Éá„Éê„Ç§„Çπ„Ç®„É©„Éº: " + e.message); this.endCall(); }
            },
            handleWebRTC: async function(pl) {
                try {
                    if(pl.cmd === 'offer') {
                        if(confirm("ÁùÄ‰ø°„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂøúÁ≠î„Åó„Åæ„Åô„ÅãÔºü")) {
                            this.showCallScreen("ÈÄöË©±‰∏≠", "?");
                            this.rtc.stream = await navigator.mediaDevices.getUserMedia({audio:true});
                            this.rtc.pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
                            this.rtc.pc.onicecandidate = e => { if(e.candidate) this.sig('candidate', e.candidate); };
                            this.rtc.pc.ontrack = e => { document.getElementById('remote-audio').srcObject = e.streams[0]; };
                            this.rtc.stream.getTracks().forEach(t=>this.rtc.pc.addTrack(t,this.rtc.stream));
                            await this.rtc.pc.setRemoteDescription(pl.data);
                            const ans = await this.rtc.pc.createAnswer();
                            await this.rtc.pc.setLocalDescription(ans);
                            this.sig('answer', ans);
                        }
                    } else if(pl.cmd === 'answer') { await this.rtc.pc.setRemoteDescription(pl.data);
                    } else if(pl.cmd === 'candidate') { await this.rtc.pc.addIceCandidate(pl.data);
                    } else if(pl.cmd === 'bye') { this.endCall(); }
                } catch(e) {}
            },
            sig: function(cmd, data) {
                const payload = { type:'sig', cmd:cmd, data:data, target:this.chats[this.activeRoom].partnerId };
                this.client.publish(`skyped/chat/${this.activeRoom}`, JSON.stringify(payload));
            },
            endCall: function() {
                this.sig('bye', {});
                document.getElementById('call-screen').style.display='none';
                if(this.rtc.stream) this.rtc.stream.getTracks().forEach(t=>t.stop());
                if(this.rtc.pc) this.rtc.pc.close();
            },
            showCallScreen: (s,a) => {
                document.getElementById('call-screen').style.display='flex';
                document.getElementById('call-status').innerText=s;
                document.getElementById('call-avatar').innerText=a;
            },
            
            escape: s => s ? s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])) : '',
            formatTime: ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            scrollToBottom: () => { const el=document.getElementById('messages'); setTimeout(()=>el.scrollTop=el.scrollHeight,10); }
        };
    </script>
</body>
</html>